---
title: プロパティ ページの追加 (ATL チュートリアル、パート 6)
ms.custom: get-started-article
ms.date: 09/27/2018
ms.assetid: df80d255-e7ea-49d9-b940-3f012e90cf9b
ms.openlocfilehash: 2c487d1446f5d1050868f2066359e9639f474ba3
ms.sourcegitcommit: 00e26915924869cd7eb3c971a7d0604388abd316
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/10/2019
ms.locfileid: "65524682"
---
# <a name="adding-a-property-page-atl-tutorial-part-6"></a>プロパティ ページの追加 (ATL チュートリアル、パート 6)

> [!NOTE] 
> ATL OLE DB プロバイダー ウィザードは、Visual Studio 2019 以降では使用できません。

プロパティ ページは個別の COM オブジェクトとして実装されるため、必要に応じて共有することができます。 この手順では、次のタスクを行ってプロパティ ページをコントロールに追加します。

- プロパティ ページのリソースを作成する

- コードを追加してプロパティ ページを作成および管理する

- プロパティ ページをコントロールに追加する

## <a name="creating-the-property-page-resource"></a>プロパティ ページのリソースを作成する

プロパティ ページをコントロールに追加するには、ATL プロパティ ページ テンプレートを使用します。

### <a name="to-add-a-property-page"></a>プロパティ ページを追加するには

1. **ソリューション エクスプローラー**で `Polygon` を右クリックします。

1. ショートカット メニューの **[追加]**  >  **[新しい項目]** をクリックします。

1. テンプレートの一覧で **[ATL]**  >  **[ATL プロパティ ページ]** を選択し、 **[追加]** をクリックします。

1. **ATL プロパティ ページ ウィザード**が表示されたら、**short**名前として「*PolyProp*」と入力します。

1. **[文字列]** をクリックして **[文字列]** ページを開き、**タイトル**として「 **&Polygon**」と入力します。

   プロパティ ページの**タイトル**は、そのページのタブに表示される文字列です。 **ドキュメント文字列**は、プロパティ フレームのステータス行またはツール ヒントに表示される説明です。 標準のプロパティ フレームでは現在この文字列が使用されないため、既定の内容のままにすることができる点に注意してください。 現時点では**ヘルプ ファイル**を生成しないので、そのテキスト ボックス内のエントリを削除します。

1. **[完了]** をクリックすると、プロパティ ページ オブジェクトが作成されます。

次の 3 つのファイルが作成されます。

|ファイル|説明|
|----------|-----------------|
|PolyProp.h|プロパティ ページを実装する C++クラス `CPolyProp` が含まれています。|
|PolyProp.cpp|PolyProp.h ファイルが含まれています。|
|PolyProp.rgs|プロパティ ページ オブジェクトを登録するレジストリ スクリプトです。|

次のコード変更も行われます。

- 新しいプロパティ ページが Polygon.cpp のオブジェクト エントリ マップに追加されます。

- `PolyProp` クラスが Polygon.idl ファイルに追加されます。

- 新しいレジストリ スクリプト ファイル PolyProp.rgs がプロジェクトのリソースに追加されます。

- ダイアログ ボックスのテンプレートがプロパティ ページのプロジェクトのリソースに追加されます。

- 指定したプロパティの文字列がリソース文字列テーブルに追加されます。

次に、プロパティ ページに表示するフィールドを追加します。

### <a name="to-add-fields-to-the-property-page"></a>プロパティ ページにフィールドを追加するには

1. **ソリューション エクスプローラー**で Polygon.rc リソース ファイルをダブルクリックします。 これにより、**リソース ビュー**が開きます。

1. **リソース ビュー**で `Dialog` ノードを展開し、`IDD_POLYPROP` をダブルクリックします。 表示されるダイアログ ボックスは空白で、コントロールを挿入する場所を示すラベルだけが表示されていることに注意してください。

1. そのラベルを選択して `Sides:` に変更します。これには、 **[プロパティ]** ウィンドウ内の **[キャプション]** のテキストを変更します。

1. テキストのサイズに合わせてラベル ボックスのサイズを変更します。

1. **ツールボックス**からラベルの右側に**編集コントロール**をドラッグします。

1. 最後に、 **[プロパティ]** ウィンドウを使用して編集コントロールの **ID** を `IDC_SIDES` に変更します。

これで、プロパティ ページのリソースを作成するプロセスが完了します。

## <a name="adding-code-to-create-and-manage-the-property-page"></a>コードを追加してプロパティ ページを作成および管理する

プロパティ ページのリソースを作成したので、実装コードを記述する必要があります。

まず、`CPolyProp` クラスを有効にして、 **[適用]** ボタンが押されたときのオブジェクトの側面の数を設定します。

### <a name="to-modify-the-apply-function-to-set-the-number-of-sides"></a>Apply 関数を変更して側面の数を設定するには

1. PolyProp.h の `Apply` 関数を次のコードに置き換えます。

    [!code-cpp[NVC_ATL_Windowing#58](../atl/codesnippet/cpp/adding-a-property-page-atl-tutorial-part-6_1.h)]

プロパティ ページには同時に複数のクライアントをアタッチできるため、`Apply` 関数は繰り返し実行し、編集ボックスから取得した値を持つ各クライアントに対して `put_Sides` を呼び出します。 ここで使用している [CComQIPtr](../atl/reference/ccomqiptr-class.md) クラスは、各オブジェクトに対して `QueryInterface` を実行し、(`m_ppUnk` 配列に格納されている) `IUnknown` インターフェイスから `IPolyCtl` インターフェイスを取得します。

このコードは、この段階で `Sides` プロパティの設定が実際に行われたかどうかをチェックします。 失敗していた場合、コードはメッセージ ボックスを表示して、`IErrorInfo` インターフェイスからのエラーの詳細を表示します。 通常、コンテナーはまずオブジェクトに `ISupportErrorInfo` インターフェイスを要求して `InterfaceSupportsErrorInfo` を呼び出し、そのオブジェクトでエラー情報の設定がサポートされているかどうかを確認します。 このタスクは省略できます。

[CComPtr](../atl/reference/ccomptr-class.md) によって参照カウントが自動的に処理されるため、インターフェイスで `Release` を呼び出す必要がありません。 `CComBSTR` では BSTR の処理が行われるため、最後に `SysFreeString` の呼び出しを実行する必要がありません。 また、さまざまな文字列変換クラスのいずれかを使用して、BSTR を必要に応じて変換することができます (これが、関数の先頭に USES_CONVERSION マクロがある理由です)。

さらに、プロパティ ページのダーティー フラグを設定し、 **[適用]** ボタンを有効にする必要があることを示す必要があります。 これは、ユーザーが **[側面]** 編集ボックスの値を変更したときに発生します。

### <a name="to-handle-the-apply-button"></a>[適用] ボタンを処理するには

1. **クラス ビュー**で `CPolyProp` を右クリックし、ショートカット メニューの **[プロパティ]** をクリックします。

1. **[プロパティ]** ウィンドウの **[イベント]** アイコンをクリックします。

1. イベント一覧で `IDC_SIDES` ノードを展開します。

1. `EN_CHANGE` を選択し、右側のドロップダウン メニューで **\<[追加] > [OnEnChangeSides]** をクリックします。 `OnEnChangeSides` ハンドラーの宣言が Polyprop.h に、ハンドラーの実装が Polyprop.cpp に追加されます。

次に、ハンドラーを変更します。

### <a name="to-modify-the-onenchangesides-method"></a>OnEnChangeSides メソッドを変更するには

1. Polyprop.cpp の次のコードを `OnEnChangeSides` メソッドに追加します (ウィザードによって配置されているコードはすべて削除します)。

    [!code-cpp[NVC_ATL_Windowing#59](../atl/codesnippet/cpp/adding-a-property-page-atl-tutorial-part-6_2.cpp)]

`IDC_SIDES` コントロールの `EN_CHANGE` の通知とともに `WM_COMMAND` メッセージが送信されるときに、`OnEnChangeSides` が呼び出されます。 その後 `OnEnChangeSides` は `SetDirty` を呼び出して TRUE を渡し、プロパティ ページがダーティになり、 **[適用]** ボタンを有効にする必要があることを示します。

## <a name="adding-the-property-page-to-the-control"></a>プロパティ ページをコントロールに追加する

プロジェクトには複数のコントロールがある可能性があるため、ATL プロパティ ページのテンプレートやウィザードによって、コントロールにプロパティ ページが自動的に追加されることはありません。 コントロールのプロパティ マップにエントリを追加する必要があります。

### <a name="to-add-the-property-page"></a>プロパティ ページを追加するには

1. PolyCtl.h を開き、次の行をプロパティ マップに追加します。

    [!code-cpp[NVC_ATL_Windowing#60](../atl/codesnippet/cpp/adding-a-property-page-atl-tutorial-part-6_3.h)]

コントロールのプロパティ マップは次のようになります。

[!code-cpp[NVC_ATL_Windowing#61](../atl/codesnippet/cpp/adding-a-property-page-atl-tutorial-part-6_4.h)]

プロパティ ページの CLSID を使用して `PROP_PAGE` マクロを追加する方法もありますが、上記のように `PROP_ENTRY` マクロを使用すると、コントロールの保存時に `Sides` プロパティの値も保存されます。

このマクロへの 3 つのパラメーターは、プロパティの説明、プロパティの DISPID、そのプロパティを持つプロパティ ページの CLSID です。 これが役に立つのは、たとえば Visual Basic にコントロールを読み込み、設計時に側面の数を設定する場合です。 側面の数を保存すると、Visual Basic プロジェクトを再読み込みするときに側面の数が復元されるからです。

## <a name="building-and-testing-the-control"></a>コントロールのビルドとテスト

次は、このコントロールをビルドし、ActiveX コントロール テスト コンテナーに挿入します。 **テスト コンテナー**の **[編集]** メニューで、 **[PolyCtl クラス オブジェクト]** をクリックします。 プロパティ ページが開き、追加した情報が表示されます。

**[適用]** ボタンは最初は無効になっています。 **[側面]** ボックスで値の入力を開始すると、 **[適用]** ボタンが有効になります。 値の入力が完了したら、 **[適用]** ボタンをクリックします。 コントロールの表示が変化して、 **[適用]** ボタンが再び無効になります。 無効な値を入力してみてください。 メッセージ ボックスが開き、`put_Sides` 関数で設定したエラーの説明が表示されます。

次は、コントロールを Web ページに配置します。

[手順 5 に戻る](../atl/adding-an-event-atl-tutorial-part-5.md) &#124; [手順 7 に進む](../atl/putting-the-control-on-a-web-page-atl-tutorial-part-7.md)

## <a name="see-also"></a>関連項目

[チュートリアル](../atl/active-template-library-atl-tutorial.md)
