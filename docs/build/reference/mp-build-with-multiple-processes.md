---
title: /MP (複数のプロセスを使用したビルド)
ms.date: 04/08/2019
f1_keywords:
- VC.Project.VCCLCompilerTool.MultiProcessorCompilation
helpviewer_keywords:
- -MP compiler option (C++)
- /MP compiler option (C++)
- MP compiler option (C++)
- cl.exe compiler, multi-process build
ms.openlocfilehash: e005b0314e87270e81dbb155dfdaa67be067cd3f
ms.sourcegitcommit: 0ab61bc3d2b6cfbd52a16c6ab2b97a8ea1864f12
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/23/2019
ms.locfileid: "62320982"
---
# <a name="mp-build-with-multiple-processes"></a>/MP (複数のプロセスを使用したビルド)

**/MP** オプションは、コマンドラインでソース ファイルをコンパイルするための合計時間を短縮できます。 **/MP** オプションによって、コンパイラは 1 つまたは複数のそれ自身のコピーを、それぞれ別のプロセスで作成できます。 これらのコピーで、同時にソース ファイルをコンパイルします。 その結果、ソース ファイルをビルドするための合計時間を大幅に短縮することができます。

## <a name="syntax"></a>構文

> **/MP**[*processMax*]

## <a name="arguments"></a>引数

*processMax*<br/>
(省略可能) コンパイラが作成できるプロセスの最大数。

*ProcessMax*引数は 65536 で範囲 1 ~ する必要があります。 それ以外の場合、コンパイラが警告メッセージを発行**D9014**、無視、 *processMax*引数、プロセスの最大数は 1 を前提としています。

省略した場合、 *processMax*引数の数を取得するコンパイラ[有効なプロセッサ](#effective_processors)オペレーティング システムからコンピューターにプロセッサごとのプロセスを作成します。

## <a name="remarks"></a>Remarks

**/MP** コンパイラ オプションは、多くのファイルをコンパイルするときに、ビルド時間を大幅に短縮できます。 ビルド時間を向上させるため、コンパイラは最大作成*processMax*自体のコピーし、それらのコピーを使用して、同時に、ソース ファイルをコンパイルします。 **/MP** オプションはコンパイルに適用されますが、リンクやリンク時のコード生成には適用されません。 既定では、 **/MP** オプションはオフです。

ビルド時間の向上は、コンピューター上のプロセッサ数、コンパイルするファイルの数、および I/O 容量などのシステム リソースの可用性に依存します。 **/MP** オプションを試して、特定のプロジェクトをビルドするのに最適な設定を確認してください。 この判断を行う際に役立つアドバイスについては、 [ガイドライン](#guidelines)をご覧ください。

## <a name="incompatible-options-and-language-features"></a>互換性のないオプションと言語機能

**/MP** オプションは一部のコンパイラ オプションや言語機能と互換性がありません。 互換性のないコンパイラ オプションを使用する場合、 **/MP**オプション、コンパイラ警告が発行**d9030 を発行**を無視し、 **/MP**オプション。 互換性のない言語機能を使用する場合、コンパイラはエラー [C2813](../../error-messages/compiler-errors-2/compiler-error-c2813.md)し終了または現在のコンパイラの警告レベル オプションに応じて続行されます。

> [!NOTE]
> ほとんどのオプションは、許可されると、同時に実行される複数のコンパイラによって、コンソールや特定のファイルに同時に出力が書き込まれることになるため、互換性がありません。 その結果、出力にさまざまな情報が混在し、文字が正しく表示されません。 オプションの組み合わせによっては、パフォーマンスが低下する場合もあります。

次の表に、 **/MP** オプションと互換性のないコンパイラ オプションや言語機能を示します。

|オプションまたは言語機能|説明|
|--------------------------------|-----------------|
|[#import](../../preprocessor/hash-import-directive-cpp.md) プリプロセッサ ディレクティブ|タイプ ライブラリの型を C++ クラスに変換し、それらのクラスをヘッダー ファイルに書き込みます。|
|[/E](e-preprocess-to-stdout.md)、 [/EP](ep-preprocess-to-stdout-without-hash-line-directives.md)|プリプロセッサ出力を標準出力 (**stdout**) にコピーします。|
|[/Gm](gm-enable-minimal-rebuild.md)|非推奨。 インクリメンタル リビルドを有効にします。|
|[/showIncludes](showincludes-list-include-files.md)|インクルード ファイルのリストを標準エラー出力 (**stderr**) に書き込みます。|
|[/Yc](yc-create-precompiled-header-file.md)|プリコンパイル済みヘッダー ファイルを書き込みます。|

## <a name="diagnostic-messages"></a>診断メッセージ

**/MP** オプションと互換性がないオプションまたは言語機能を指定した場合、診断メッセージが表示されます。 次の表に、メッセージと、コンパイラの動作を示します。

|診断メッセージ|説明|コンパイラの動作|
|------------------------|-----------------|-----------------------|
|**C2813**|**#import** ディレクティブは **/MP** オプションと互換性がありません。|[コンパイラの警告レベル](compiler-option-warning-level.md) オプションで他の方法が指定されている場合を除き、コンパイルは終了します。|
|**D9014**|無効な値が指定されて、 *processMax*引数。|コンパイラは、無効な値を無視し、値が 1 であると見なします。|
|**D9030**|指定されたオプションは **/MP**オプションと互換性がありません。|コンパイラは **/MP** オプションを無視します。|

## <a name="guidelines"></a> ガイドライン

### <a name="measure-performance"></a>パフォーマンスの計測

合計ビルド時間を使用して、パフォーマンスを計測します。 物理クロックを使用してビルド時間を計測することも、ソフトウェアを使用してビルドの開始時と停止時の差を計算することもできます。 お使いのコンピューターに複数のプロセッサがある場合は、ソフトウェアによる時間の計測よりも、物理クロックの方がより正確な計測結果が生成される可能性があります。

### <a name="effective_processors"></a> Effective Processors

コンピューターが 1 つまたは複数の仮想プロセッサとも呼ばれますが*有効なプロセッサ*、その物理プロセッサごとにします。 各物理プロセッサは 1 つまたは複数のコアを持つことができ、オペレーティング システムでコアのハイパースレッディングが有効になっている場合、各コアは 2 つの仮想プロセッサとして表示されます。

たとえば、コンピューターに 1 つのコアを持つ物理プロセッサが 1 つ搭載されており、ハイパースレッディングが無効になっている場合、有効なプロセッサは 1 つです。 これに対し、コンピューターに 2 つの物理プロセッサがあり、それぞれが 2 つのコアを持ち、すべてのコアのハイパースレッディングが有効になっている場合、コンピューターの有効なプロセッサは 8 つになります。 (有効なプロセッサを 8) (2 つの物理プロセッサ) = x (物理プロセッサあたり 2 コア) x (ハイパースレッディングによりコアあたりの 2 効果的なプロセッサ)。

省略した場合、 *processMax*引数、 **/MP**オプション、コンパイラは、オペレーティング システムから有効なプロセッサの数を取得および有効なプロセッサあたり 1 つのプロセスが作成されます。 ただし、コンパイラは特定のプロセッサでどのプロセスを実行するかを保証することはできません。この決定は、オペレーティング システムによって行われます。

### <a name="number-of-processes"></a>プロセス数

コンパイラは、ソース ファイルをコンパイルするために使用するプロセスの数を計算します。 この値は、コマンド ラインで指定したソース ファイルの数および **/MP** オプションで明示的または暗黙的に指定したプロセスの数より小さくなります。 指定した場合、プロセスの最大数を明示的に設定することができます、 *processMax*の引数、 **/MP**オプション。 等しい有効なプロセッサの数のコンピューターで省略した場合は、既定値を使用することも、 *processMax*引数。

たとえば、次のようなコマンド ラインを指定したとします。

`cl /MP7 a.cpp b.cpp c.cpp d.cpp e.cpp`

この場合、コンパイラは、ソース ファイル数の 5 と最大プロセス数の 7 の小さい方である 5 つのプロセスを使用します。 また、コンピューターに 2 つの有効なプロセッサがあり、次のコマンド ラインを指定するとします。

`cl /MP a.cpp b.cpp c.cpp`

この場合、オペレーティング システムは 2 つのプロセッサを報告します。したがって、コンパイラは、その計算に 2 つのプロセスを使用します。 その結果、コンパイラは 2 つのプロセスでビルドを実行します。これは、プロセス数 2 とソース ファイル数 3 の小さい方であるためです。

### <a name="source-files-and-build-order"></a>ソース ファイルとビルド順序

ソース ファイルは、コマンド ラインで表示される順序と同じ順序でコンパイルされない可能性があります。 コンパイラは、コンパイラのコピーが含まれている一連のプロセスを作成しますが、オペレーティング システムが各プロセスを実行するタイミングをスケジュールします。 その結果、特定の順序でソース ファイルをコンパイルすることを保証できません。

ソース ファイルは、ソース ファイルをコンパイルするプロセスが利用可能になったときにコンパイルされます。 プロセスよりも多くのファイルがある場合は、利用可能なプロセスによってファイルの最初のセットがコンパイルされます。 残りのファイルは、プロセスが前のファイルの処理を終了し、残りのファイルのいずれかを処理できるようになると処理されます。

コマンド ラインで同じソース ファイルを複数回指定しないでください。 このような状況は、プロジェクト内の依存関係情報に基づいて、ツールが自動的に [makefile](contents-of-a-makefile.md) を作成する場合などに発生します。 **/MP** オプションを指定しない場合、コンパイラはファイルの一覧を順番に処理し、ファイルが出現するたびに再コンパイルします。 ただし、 **/MP** オプションを指定した場合、異なるコンパイラが同時に同じファイルをコンパイルする場合があります。 その結果、異なるコンパイラが、同時に同じ出力ファイルへの書き込みを試みます。 1 つのコンパイラは、出力ファイルへの排他書き込みアクセスを取得して成功し、他方のコンパイラは、ファイル アクセス エラーで失敗します。

### <a name="using-type-libraries-import"></a>タイプ ライブラリの使用 (#import)

コンパイラは、 [#import](../../preprocessor/hash-import-directive-cpp.md) ディレクティブを **/MP** スイッチと共に使用することはサポートしていません。 可能であれば、次の手順に従って、この問題を回避してください。

- さまざまなソース ファイル内の `#import` ディレクティブをすべて 1 つまたは複数のファイルに移動し、それらのファイルを **/MP** オプションを指定せずにコンパイルします。 これにより、一連のヘッダー ファイルが生成されます。

- 残りのソース ファイルで、生成されたヘッダーを指定する [#include](../../preprocessor/hash-include-directive-c-cpp.md) ディレクティブを挿入し、 **/MP** オプションを使用して残りのソース ファイルをコンパイルします。

### <a name="visual-studio-project-settings"></a>Visual Studio プロジェクトの設定

#### <a name="the-msbuildexe-tool"></a>MSBUILD.exe ツール

Visual Studio を使用して、 [MSBuild.exe](/visualstudio/msbuild/msbuild-reference)ソリューションとプロジェクトをビルドするためのツール。 **/Maxcpucount:**_数_(または **/m:**_数_) で複数のプロジェクトのビルドを MSBuild.exe ツールのコマンド ライン オプション、同時にします。 また、 **/MP** コンパイラ オプションによって、同時に複数のコンパイル ユニットをビルドすることができます。 アプリケーションで適切である場合は、 **/MP** と **/maxcpucount**のいずれかまたは両方を使用して、ソリューションのビルド時間を向上させてください。

ソリューションのビルド時間は、部分的に、ビルドを実行するプロセスの数に依存しています。 *数*の引数、 [/maxcpucount](/visualstudio/msbuild/msbuild-command-line-reference) MSBuild オプションを同時にビルドするプロジェクトの最大数を指定します。 同様に、 *processMax*の引数、 **/MP**コンパイラ オプションを同時にビルドをコンパイル単位の最大数を指定します。 場合、 **/maxcpucount**オプションを指定します*P*プロジェクトと **/MP**オプションを指定します*C*を処理する最大*P* x *C*プロセスを同時に実行します。

MSBuild を使用するかどうかを決定するためのガイドラインまたは **/MP**テクノロジは、次のようにします。

- 各プロジェクトでいくつかのファイルで多くのプロジェクトがある場合は、MSBuild ツールを使用します。

- プロジェクトの数が少なく、各プロジェクトのファイルが多い場合は、 **/MP** オプションを使用します。

- プロジェクトとプロジェクトごとのファイルの数が分散された場合は、両方の MSBuild を使用して、 **/MP**します。 初期設定では、 **/maxcpucount** オプションをビルドするプロジェクトの数に設定し、 **/MP** オプションをコンピューター上のプロセッサの数に設定します。 パフォーマンスを測定し、最適な結果を得られるように、設定を調整します。 合計のビルド時間に満足できるまで、このサイクルを繰り返します。

## <a name="see-also"></a>関連項目

[#import ディレクティブ](../../preprocessor/hash-import-directive-cpp.md)<br/>
[Command-Line Reference (コマンド ライン リファレンス)](/visualstudio/msbuild/msbuild-command-line-reference)<br/>
[/Zf (PDB 生成の高速化)](zf.md)<br/>
