---
title: プロファイル ガイド付き最適化
ms.date: 04/23/2019
helpviewer_keywords:
- profile-guided optimizations
- optimization, profile-guided [C++]
ms.assetid: 2225c307-d3ae-42c1-8345-a5a959d132dc
ms.openlocfilehash: 46619e77861b6a3a78d74ce6c6d9173a3a5f270f
ms.sourcegitcommit: 283cb64fd7958a6b7fbf0cd8534de99ac8d408eb
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/28/2019
ms.locfileid: "64857324"
---
# <a name="profile-guided-optimizations"></a>プロファイル ガイド付き最適化

最適化のガイド付きプロファイル (PGO) を使用して、オプティマイザーが、.exe または .dll ファイルのテストの実行からのデータを使用して、まったく実行可能ファイルを最適化できます。 データは、運用環境でプログラムの可能性の高いパフォーマンスを表します。

プロファイル ガイド付き最適化の x86 または x64 のネイティブ ターゲットにのみ利用できます。 プロファイル ガイド付き最適化は、共通言語ランタイムで実行される実行可能ファイルを使用できません。 ネイティブおよびマネージの混合コードとアセンブリを生成した場合でも (を使用して、 **/clr**コンパイラ オプション)、ネイティブ コードのみプロファイル ガイド付き最適化を使用することはできません。 IDE で設定するこれらのオプションでプロジェクトをビルドしようとした場合、ビルド エラーが発生します。

> [!NOTE]
> プロファイリングのテスト実行から収集される情報にはそれ以外の場合に効果を指定する場合の最適化よりも優先されます **/Ob**、 **/Os**、または **/Ot**します。 詳細については、次を参照してください。 [/Ob (関数のインライン展開)](reference/ob-inline-function-expansion.md)と[/Os、/Ot (実行速度の優先、優先する高速コード)](reference/os-ot-favor-small-code-favor-fast-code.md)します。

## <a name="steps-to-optimize-your-app"></a>アプリを最適化する手順

プロファイル ガイド付き最適化を使用するには、アプリを最適化するために次の手順に従います。

- 1 つまたは複数のソース コード ファイルをコンパイル[/GL](reference/gl-whole-program-optimization.md)します。

   各モジュールで構築された **/GL**プロファイル ガイド付き最適化の実行時の動作をキャプチャするテストの実行中に調べることができます。 プロファイル ガイド付き最適化のビルドのすべてのモジュールを指定してコンパイルする必要はありません **/GL**します。 これらのモジュールがコンパイルただし、 **/GL**プロファイル ガイド付き最適化をインストルメント化され、後で使用できます。

- 使用してリンク[/LTCG](reference/ltcg-link-time-code-generation.md)と[/GENPROFILE または/FASTGENPROFILE](reference/genprofile-fastgenprofile-generate-profiling-instrumented-build.md)します。

   両方を使用して **/LTCG**と **/GENPROFILE**または **/FASTGENPROFILE**作成、`.pgd`ファイルのインストルメント化されたアプリを実行するとします。 テストの実行のデータに追加した後、`.pgd`ファイルに次のリンク ステップ (最適化されたイメージを作成する) への入力として使用できます。 指定するときに **/GENPROFILE**、必要に応じて追加することができます、 **PGD =**_filename_既定以外の名前または場所を指定する引数、`.pgd`ファイル。 組み合わせた **/LTCG**と **/GENPROFILE**または **/FASTGENPROFILE**リンカー オプションは非推奨とされる置換 **/LTCG:PGINSTRUMENT**リンカー オプション。

- アプリケーションのプロファイリングを行います。

   プロファイリングされた EXE セッションが終了するたびに、または、プロファイリングされた DLL がアンロードされて、`appname!N.pgc`ファイルが作成されます。 A`.pgc`ファイルには、特定のアプリケーション テストの実行に関する情報が含まれています。 *appname* 、アプリの名前を指定し、 *N*他の数に基づきますにインクリメントされる 1 で始まる数値`appname!N.pgc`ディレクトリ内のファイル。 削除することができます、`.pgc`ファイル、テストの実行を最適化しシナリオを表していない場合。

   テストの実行中には、現在開いてのクロージャを強制できます`.pgc`ファイルと新しい作成`.pgc`ファイルと、 [pgosweep](pgosweep.md) (たとえば、テスト シナリオの最後は、アプリケーションと一致しない場合は、ユーティリティシャット ダウン)。

   アプリケーションは直接呼び出すことも、PGO 関数[PgoAutoSweep](pgoautosweep.md)、として呼び出しの時点のプロファイル データをキャプチャする、`.pgc`ファイル。 キャプチャされたデータを対象となるコードをより細かく制御を提供することができますが、`.pgc`ファイル。 この関数を使用する方法の例は、次を参照してください。、 [PgoAutoSweep](pgoautosweep.md)ドキュメント。

   既定では、インストルメント化されたビルドを作成するときに、データ コレクションがスレッド セーフ モードでは高速ですが、正確でない可能性がありますで実行されます。 使用して、 **EXACT**引数 **/GENPROFILE**または **/FASTGENPROFILE**より正確には、スレッド セーフ モードでデータ コレクションを指定する速度が低下します。 このオプションは非推奨に設定した場合でも[PogoSafeMode](environment-variables-for-profile-guided-optimizations.md#pogosafemode)環境変数、または非推奨とされる **/POGOSAFEMODE**リンカー オプション、インストルメント化されたビルドを作成するときにします。

- 使用してリンク **/LTCG**と **/USEPROFILE**します。

   両方を使用して、 **/LTCG**と[/USEPROFILE](reference/useprofile.md)最適化されたイメージを作成するためのリンカー オプション。 この手順は、入力、`.pgd`ファイル。 指定すると **/USEPROFILE**、必要に応じて追加することができます、 **PGD =**_filename_既定以外の名前または場所を指定する引数、`.pgd`ファイル。 非推奨を使用してこの名前を指定することもできます。 **/PGD**リンカー オプション。 組み合わせた **/LTCG**と **/USEPROFILE** 、非推奨が置き換えられます **/LTCG:PGOPTIMIZE**と **/LTCG:PGUPDATE**リンカー オプション。

さらに最適化された実行可能ファイルを作成し、後で判明する追加のプロファイリングがあるより最適化されたイメージを作成すると便利にできますが。 場合、インストルメント化されたイメージとその`.pgd`ファイルは、追加のテストの実行を行うし、新しいと、最適化されたイメージを再構築`.pgd`同じを使用して、ファイル **/LTCG**と **/USEPROFILE**リンカー オプション。

## <a name="optimizations-performed-by-pgo"></a>PGO によって実行される最適化

プロファイル ガイド付き最適化には、これらのチェックと機能強化が含まれます。

- **インライン展開**- たとえば、関数、関数の B を頻繁に呼び出すと、関数 B が比較的小さくし、プロファイル ガイド付き最適化のインライン関数 B 関数 A. で

- **仮想呼び出し推理**-プロファイル ガイド付き最適化が頻繁に対象の関数の条件付きで実行される直接呼び出しを挿入できる仮想呼び出し、またはその他の呼び出し、関数ポインターを通じて対象が特定の関数が頻繁の場合、直接の呼び出しはインライン展開できます。

- **レジスタ割り当て**-レジスタ割り当てを最適化するプロファイル データが改善されます。

- **基本ブロックの最適化**-基本ブロックの最適化により、同じ一連のページ (ローカリティ) に配置するのには特定のフレーム内で一時的に実行される一般的な実行の基本的な要素です。 メモリのオーバーヘッドを最小限に抑えられますページの数が最小限に抑えます。

- **サイズ/速度の最適化**-プログラムが、最も実行時間を費やす関数の速度を最適化できます。

- **関数のレイアウト**- 呼び出し先に基づいており、呼び出し元/呼び出し先の動作、プロファイリングの対象となる傾向があります、同じ実行パスを関数内の同じセクションに配置します。

- **条件付き分岐の最適化**-プロファイル ガイド付きの値プローブを使用して、最適化が switch ステートメントで指定した値が他の値よりも頻繁に使用されるかどうかを検索することができます。  この値は switch ステートメントから取得できます。  実行できる同じ`if`.`else`手順については、オプティマイザーを並べ替えることができます、 `if`.`else`ことから、`if`または`else`ブロックが最初に配置されるブロックによってがより頻繁に true を指定します。

- **実行されないコード分離**-プロファイリング中に設定されていないというコード、一連のセクションの末尾に追加した特別なセクションに移動します。 実質的に、頻繁に使用されるページからこのセクションを保持します。

- **EH コード分離付き**-ため EH コードが実行される非常にのみ、別のセクションに移動することがあります。 プロファイル ガイド付き最適化のか、例外が例外的な状況でのみ実行することを調べるときに移動されます。

- **メモリの組み込み**- かどうかには、頻繁に呼び出されますに依存したかどうか、組み込みの順に展開するかどうか。 また、組み込みは、移動またはコピーのブロック サイズに基づいて最適化することもできます。

## <a name="next-steps"></a>次の手順

これらの環境変数、関数、およびツールについてもっと読むプロファイル ガイド付き最適化に使用できます。

[プロファイル ガイド付き最適化のための環境変数](environment-variables-for-profile-guided-optimizations.md)<br/>
これらの変数が使用すると、テストのシナリオの実行時の動作を指定します。 非推奨とされ、新しいリンカー オプションに置き換えしているようになりました。 このドキュメントでは、環境変数からリンカー オプションに移動する方法を示します。

[PgoAutoSweep](pgoautosweep.md)<br/>
詳細を提供するアプリに追加できます関数`.pgc`ファイル データのキャプチャの管理。

[pgosweep](pgosweep.md)<br/>
すべてのプロファイル データを書き込むコマンド ライン ユーティリティ、`.pgc`ファイルを閉じ、`.pgc`ファイルを開き、新しい開きます`.pgc`ファイル。

[pgomgr](pgomgr.md)<br/>
1 つ以上のプロファイル データを追加するコマンド ライン ユーティリティ`.pgc`ファイルを`.pgd`ファイル。

[方法: 複数の PGO プロファイルを 1 つのプロファイルにマージします。](how-to-merge-multiple-pgo-profiles-into-a-single-profile.md)<br/>
例の**pgomgr**使用量。

## <a name="see-also"></a>関連項目

[追加の MSVC ビルド ツール](reference/c-cpp-build-tools.md)
